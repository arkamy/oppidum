<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>

	<title>Créer des sites Web avec Oppidum</title>
	
</head>

<body>
  <h1 id="packager_une_application_pour_tomcat_avec_oppidum">Packager une application pour Tomcat avec Oppidum</h1>

  <p>Par Stéphane Sire (Oppidoc), <a href="&#109;&#97;&#105;&#x6C;&#x74;&#111;:&#115;&#46;&#x73;&#105;&#114;&#x65;&#64;&#x66;&#114;&#x65;&#x65;.&#x66;&#114;">&#115;&#46;&#x73;&#105;&#114;&#x65;&#64;&#x66;&#114;&#x65;&#x65;.&#x66;&#114;</a>, Janvier 2012</p>

  <p>Suivre les étapes suivantes :</p>

  <ol>
  <li>Générer le fichier WAR contenant eXist</li>
  <li>Générer l&#8217;archive oppidum.zip contenant la librairie Oppidum</li>
  <li>Générer l&#8217;archive app-code.zip contenant le code de l&#8217;application</li>
  <li>Générer l&#8217;archive app-data.zip contenant les données de l&#8217;application</li>
  </ol>

  <h2 id="distribution_de_l8217application_sous_tomcat">Distribution de l&#8217;application sous Tomcat</h2>

  <p>Sous Tomcat le code de la librairie Oppidum, le code de l&#8217;application et les données de l&#8217;application sont situés dans la BD dans les collections suivantes :</p>

  <ul>
  <li><code>db/www/oppidum</code> : librairie Oppidum</li>
  <li><code>db/www/monapp</code> (ou <code>/db/www/root</code> pour la variante universelle): code de l&#8217;application (y compris messages d&#8217;erreurs et gabarits)</li>
  <li><code>/db/sites/monapp</code> : données de l&#8217;application</li>
  </ul>

  <p>où <em>monapp</em> est le nom de l&#8217;application</p>

  <p>Le fichier <code>controller-config.xml</code> qui se trouvera à la racine du <code>WEB-INF</code> redirigera les URLs vers le contrôleur de l&#8217;application dans  <code>/db/www/monapp/controller.xql</code> (ou bien vers <code>/db/www/root/controller.xql</code> pour la variante universelle, cf. les explications ci-dessous).</p>

  <p>Le fichier WAR ne contient qu&#8217;une distribution minimale de eXist. Les mises à jour ultérieures de l&#8217;application s&#8217;effectuent directement avec le client d&#8217;administration de eXist en 2 étapes :</p>

  <ul>
  <li><p>génération d&#8217;une archive ZIP contenant le nouveau code depuis la version de développement ou de test de l&#8217;application</p></li>
  <li><p>restauration de l&#8217;archive ZIP du nouveau code sur la version en production de l&#8217;application</p></li>
  </ul>

  <p>Cette méthode de travail permet de ne pas modifier le fichier WAR déployé, et d&#8217;éviter les coûteuse opérations de redéploiement de l&#8217;application sous Tomcat qui entrainent parfois des fuites mémoire (PermGen Space).</p>

  <h2 id="astuce_pour_le_test">Astuce pour le test</h2>

  <p>Nous recommandons de réaliser et d&#8217;installer 2 distributions sous Tomcat :</p>

  <ol>
  <li>une distribution de test</li>
  <li>une distribution de production</li>
  </ol>

  <p>La distribution de test sert à tester l&#8217;application complète sur une machine de test. La distribution de production est la version mise en ligne.</p>

  <p>Dans la plupart des cas la seule différence entre ces 2 distributions étant le niveau de log défini dans le fichier <code>log4j.xml</code> (qui fait partie du WAR), si vous ne souhaitez pas packager 2 fois le fichier WAR, vous pouvez alors simplement déployer la version destinée à la production sur le serveur de test, l&#8217;arrêter, modifier à la main le fichier de configuration des logs et redémarrer l&#8217;application. Vous éviterez ainsi de devoir générer 2 fichiers WAR différents.</p>

  <h2 id="gnration_du_war">Génération du WAR</h2>

  <p>Le répertoire <code>scripts</code> de Oppidum défini une cible <code>package</code> pour générer le fichier WAR avec ant. La commande suivante :</p>

  <pre><code>cd scripts
  ant package
  </code></pre>

  <p>génère un fichier <code>oppidum-v{nb}.war</code> dans le répertoire <code>dist</code> de eXist. Éditez le fichier <code>scripts/ant.properties</code> si vous souhaitez modifier le nom du fichier généré et d&#8217;autres méta-données (product.author, product.name, product.version, pkg.war.name).</p>

  <p>Notez que à priori il est également possible de faire les même opérations depuis la distribution source de l&#8217;application si elle contient également le script ant issu de la distribution d&#8217;Oppidum (ou une version adaptée).</p>

  <p>Le fichier WAR généré contient une distribution minimale de eXist avec un minimum de modules XQuery. Par défaut les modules XQuery suivants sont inclus :</p>

  <ul>
  <li>Mail</li>
  <li>Images</li>
  </ul>

  <p>Le module <code>http://expath.org/ns/http-client</code> est désactivé car les fichiers jar correspondant ne sont pas inclus (<code>extensions/expath/lib</code>, <em>c&#8217;est peut-être un bug dans la distribution actuelle</em> signalé sur le forum).</p>

  <p>Pour changer la distribution générée vous devez modifier les fichiers suivants:</p>

  <ul>
  <li><code>config/web.xml</code> : pour changer la liste des servlets lancés</li>
  <li><code>config/prod/conf.xml</code> : pour changer les paramètres de eXist tels que les modules XQuery embarqués</li>
  <li><code>config/prod/log4j.xml</code> : pour changer la génération des logs</li>
  </ul>

  <p>Si vous modifiez les servlets dans <code>web.xml</code> ou les modules XQuery dans <code>conf.xml</code>, il se peut que vous deviez également modifier la liste des fichiers jar inclus dans le fichier WAR en éditant <code>scripts/build.xml</code>.</p>

  <p>Dans tous les cas vous devez modifier une ligne dans le fichier <code>config/controller-config.xml</code> :</p>

  <pre><code>&lt;root pattern=".*" path="xmldb:exist:///db/www/oppidum"/&gt;
  </code></pre>

  <p>en remplaçant <em>opppidum</em> par le nom de votre application. Il est aussi possible de mettre des préfixes différents pour regrouper plusieurs applications dans un seul WAR.</p>

  <p>Notons que ce fichier WAR ne contient pas de BD initiale (le répertoire <code>WEB-INF/data</code> est vide), celle-ci sera créée lors du premier lancement de l&#8217;application sous Tomcat.</p>

  <h2 id="configuration_des_logs">Configuration des logs</h2>

  <p>Mettre le niveau <code>debug</code> (ou <code>info</code>) en test.</p>

  <p>Mettre le niveau <code>error</code> (ou <code>warn</code> plus verbeux) en production.</p>

  <h2 id="gnration_des_archives_zip">Génération des archives ZIP</h2>

  <p>La librairie Oppidum ainsi que les applications contiennent un script d&#8217;installation pour copier le code et les données de l&#8217;application depuis le répertoire locale à leur emplacement pour le déploiement dans la BD.</p>

  <p>Le script d&#8217;installation (qui se trouve dans <code>scripts/install.xql</code>) est associé par défaut avec l&#8217;URL <code>/oppidum/install</code> en ce qui concerne Oppidum, et <code>/monapp/install</code> pour l&#8217;application.</p>

  <p>Ouvrez l&#8217;URL et suivez les instructions (il faut de connecter comme <code>admin</code> de la BD pour pouvoir exécuter ces scripts) pour charger le code et les données dans la BD. </p>

  <p>Lancez ensuite le client d&#8217;administration eXist pour générer les archives ZIP nécessaires.</p>

  <p>Vous aurez besoin de 3 archives si vous voulez découper finement l&#8217;application (Oppidum, le code de l&#8217;application, les données de l&#8217;application), qui se trouvent dans des collections mentionnées dans la première section.</p>

  <p>Vous pouvez alternativement créer une seule archive de la collection <code>/db</code> qui contiendra alors l&#8217;ensemble de l&#8217;application. Attention cependant si vous procédez de la sorte depuis un environnement de développement, vous risquez d&#8217;embarquer toutes les applications fournies avec eXist ainsi que la documentation eXist, ce qu&#8217;il faut éviter sur un site en production. Il est alors préférable d&#8217;effectuer le packaging depuis un environnement eXist vierge.</p>

  <h2 id="restoration_des_archives_zip">Restoration des archives ZIP</h2>

  <p>Déployez le WAR sour Tomcat et lancez le.</p>

  <p>Lancez le client d&#8217;administration eXist en vous connectant à l&#8217;application installée sous Tomcat. Par exemple, en test cela devrait être une URL de la forme <code>http://localhost:8000/monapp</code>.</p>

  <p>Si votre application nécessite des utilisateurs spécifique et des groupes spécifiques (typiquement il devrait y a voir un utilisateur &#8216;monapp&#8217; ainsi que des groupes &#8216;site-admin&#8217; et &#8216;site-member), alors créez à la main ces utilisateurs et ces groupes.</p>

  <p>Procédez ensuite à la restoration des archives ZIP crées à l&#8217;étape précédente.</p>

  <h2 id="note_sur_les_droits">Note sur les droits</h2>

  <p>Nous recommandons de fabriquer les archives ZIP et de les restaurer sur une BD eXist pour laquelle le compte <code>admin</code> possède le même mot de passe. Au besoin changez le avant de procéder à la génération des ZIP pour qu&#8217;il corresponde à celui du serveur sur lequel vous allez le restorer.</p>

  <p>À priori cette contrainte est indispensable si vous utilisez une seule archive ZIP embarquant tout la BD plutôt que le découpage indiqué ci-dessus.</p>

  <h2 id="variante_avec_fichier_war_universel">Variante avec fichier WAR universel</h2>

  <p>Le répertoire scripts de Oppidum défini également une cible <code>universal</code> pour générer le fichier WAR avec ant. La commande suivante :</p>

  <pre><code>cd scripts
  ant universal
  </code></pre>

  <p>génère un fichier <code>oppidum-uni-version.war</code> dans le répertoire <code>dist</code> de eXist. De même que pour le packaging WAR classique vous pouvez modifier le nom du fichier généré et d&#8217;autres méta-données (product.author, product.name, product.version, pkg.war.name) en éditant le fichier <code>scripts/ant.properties</code>.</p>

  <p>Le fichier WAR universel contient une version spéciale du fichier <code>web.xml</code> avec le paramètrage suivant :</p>

  <pre><code>&lt;init-param&gt;
    &lt;param-name&gt;config&lt;/param-name&gt;
    &lt;param-value&gt;xmldb:exist:///db/www/universal/controller-config.xml&lt;/param-value&gt;
  &lt;/init-param&gt;
  </code></pre>

  <p>instruisant eXist de lire le fichier <code>controller-config.xml</code> depuis la collection <code>/db/www/universal</code> de la BD.</p>

  <p><strong>Pour générer le fichier WAR universel il faut au préalable</strong>:</p>

  <ol>
  <li>invoquer le script ant depuis une installation d&#8217;eXist dans laquelle la BD (répertoire <code>data</code>) se situe dans <code>${exist-home}/webapp/WEB-INF/data</code></li>
  <li>avoir installé le fichier <code>controller-config.xml</code> universel dans la collection <code>/db/www/universal</code></li>
  </ol>

  <p>Le point 1 s&#8217;effectue au moment de l&#8217;installation de l&#8217;application eXist qui servira à générer le WAR, il faut bien préciser que la localisation du répertoire <code>data</code> sera celle indiquée ci-dessus (même si formellement elle n&#8217;existe pas encore au moment où l&#8217;on installe eXist).</p>

  <p>Le point 2 nécessite, une fois le point 1 effectué, de copier Oppidum dans le répertoire <code>webapp</code> de eXist (par exemple dans le répertoire <code>{chemin}</code>), de lancer eXist, puis de copier Oppidum dans la base de données avec la page d&#8217;installation <code>http://localhost:8080/exist/{chemin}/oppidum/install</code> (cf. le point <em>Génération des archives ZIP</em>). </p>

  <p>Au moment de l&#8217;installation il faut sélectionner le module <code>root</code> dans le code, ce qui aura pour effet d&#8217;installer le fichier <code>controller-config.xml</code> universel dans la BD.</p>

  <p>Le fichier WAR obtenu est universel car il permet d&#8217;éditer le mapping des URLs du site (par exemple pour ajouter des applications sur le site) sans modifier le WAR (et donc sans avoir à le redéployer), en modifiant directement la ressource <code>controller-config.xml</code> dans la BD. </p>

  <p>Notons cependant que comme les modifications de la ressource <code>controller-config.xml</code> ne sont pas prises en compte immédiatement par eXist (qui impose un redémarrage pour les prendre en compte). Pour y remédier le fichier <code>controller-config.xml</code> universel fait pointer toutes les URLs vers la collection <code>/db/www/root</code>. En respectant cette convention lors de la création du fichier ZIP pour le code d&#8217;une application (celui qui contient le <code>controller.xql</code>) il est ainsi possible de la déployer directement sur le fichier WAR universel sans avoir besoin de relancer eXist (donc Tomcat).</p>

  <p>Pour produire le fichier ZIP universel du code de l&#8217;application (celui qui place le code de l&#8217;application dans <code>/db/www/root</code> et non pas dans la collection <code>/db/www/monapp</code>), nous avons ajouté une option <em>universal</em> à la page d&#8217;installation des applications. Il faut alors : </p>

  <ol>
  <li>sélectionner l&#8217;option <code>universal</code> lors de l&#8217;installation du code dans la BD</li>
  <li>éditer le fichier <code>/db/www/root/controller.xql</code> et modifier l&#8217;attribute <code>confbase</code> du mapping en remplaçant <code>confbase="/db/www/monapp"</code> par <code>confbase="/db/www/root"</code></li>
  </ol>

  <p>Ensuite seulement vous pouvez générer le fichier monapp-uni-code.ZIP du code de  l&#8217;application comme expliqué ci-dessus.</p>

  <p>Notons qu&#8217;alternativement vous pouvez faire une installation standard et renommer à la main la collection <code>/db/www/monapp</code> en <code>/db/www/root</code> sans omettre le point 2 ci-dessus avant de générer le ZIP.</p>

  <p>Notons enfin qu&#8217;il est possible d&#8217;inclure dans le fichier WAR obtenu en suivant les instructions précédentes la librairie Oppidum pré-installée. Pour cela cochez tous les modules correspondants lors du point 1. Vous n&#8217;aurez ainsi pas besoin de restorer l&#8217;archive <code>oppidum.zip</code> avec le client Java d&#8217;eXist sur le WAR déployé.</p>

</body>
</html>
