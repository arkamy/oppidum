/* ***** BEGIN LICENSE BLOCK *****
 *
 * Copyright (C) 2012 S. Sire
 *
 * This file contains files from the AXEL-FORMS extension to the Adaptable XML Editing Library (AXEL)
 * Version 1.0
 *
 * AXEL-FORMS is licensed by Oppidoc SARL 
 *
 * Web site : http://www.oppidoc.fr, https://bitbucket.org/ssire/axel-forms
 * 
 * Contributors(s) : S. Sire
 * 
 * ***** END LICENSE BLOCK ***** */
 (function(){var n={};var l={type:"text"};var g=function(r,o,p){var q=r.getHandle();this._editor=r;this.isEditable=!r.getParam("noedit");this.defaultData=p||"click to edit";xtdom.setAttribute(q,"type",o);q.value=p};var i=function i(o,p){if(!n[o]){n[o]={}}n[o][p]=true};var b=function b(o,p){if(n[o]&&n[o][p]){delete n[o][p];return true}return false};g.prototype={awake:function(){var o=this._editor.getHandle();var p=this;if(this.isEditable){xtdom.addEventListener(o,"click",function(q){if(!p.isEditing()){p.startEditing(q)}xtdom.stopPropagation(q);xtdom.preventDefault(q)},true);xtdom.addEventListener(o,"blur",function(q){if(p.isEditing()){p.stopEditing(false,true)}},true)}},isFocusable:function(){return(this.isEditable&&((!this._editor.isOptional())||this._editor.isSet()))},isEditing:function(){return this._isEditing},doKeyDown:function(o){},doKeyUp:function(o){},focus:function(){var o=this._editor.isModified();if(o){this._editor.getHandle().focus()}this.startEditing({shiftKey:!o})},unfocus:function(){this.stopEditing()},load:function(q,p){var o;if(q!==-1){o=p.getDataFor(q);this._editor.getHandle().value=o||this._defaultData;this._editor.setModified(o!==this._defaultData);this._editor.set(false)}else{this._editor.clear(false)}},save:function(o){var p=this._editor.getHandle().value;if(p){o.write(p)}},startEditing:function(p){var o,q=xtiger.session(this._editor.getDocument()).load("keyboard");if(!this._isEditing){o=this._editor.getHandle();this._legacy=o.value;this._isEditing=true;this.kbdHandlers=q.register(this,o);q.grab(this,this._editor);if(p.shiftKey||!this._editor.isModified()){xtdom.focusAndSelect(o)}}},stopEditing:function(o,r){var p=this._editor.getHandle();var q=xtiger.session(this._editor.getDocument()).load("keyboard");if(this._isEditing){this._isEditing=false;q.unregister(this,this.kbdHandlers,p);q.release(this,this._editor);if(!o){this._editor.update(p.value)}if((!r)&&(p.blur)){p.blur()}}},cancelEditing:function(){this._editor.getHandle().value=this._legacy;this.stopEditing()},clear:function(){this._editor.getHandle().value=this.defaultData},update:function(o){if(o===this._legacy){return}if(o.search(/\S/)===-1||(o===this._defaultData)){this._editor.clear(true)}else{this._editor.setModified(true);this._editor.set(true)}}};var e=function(s,o,q){var r=s.getHandle(),p=s.getParam("name");this._editor=s;this._type=o;xtdom.setAttribute(r,"type",o);if(p||(o==="radio")){p=(p||"").concat(q||"");xtdom.setAttribute(r,"name",p);s._params.name=p}if(s.getParam("checked")){xtdom.setAttribute(r,"checked",s.getParam("checked"))}};e.prototype={awake:function(){var o=this._editor.getHandle();var p=this;xtdom.addEventListener(o,"click",function(q){if(p._editor.getHandle().checked){p._editor.update(p._editor.getParam("value"))}else{p._editor.update("")}},true)},isFocusable:function(){return false},load:function(s,r){var q,p,o=false;p=this._editor.getParam("value");if(-1!==s){q=r.getDataFor(s);o=(q===p);if(!o){name=this._editor.getParam("name");if(name){o=b(name,p);i(name,q)}}if(o){if(!this._editor.getHandle().checked){this._editor.getHandle().checked=true;this._editor.set(false)}}else{this._editor.clear(false)}}else{name=this._editor.getParam("name");if(name){o=b(name,p)}if(o){if(!this._editor.getHandle().checked){this._editor.getHandle().checked=true;this._editor.set(false)}}else{this._editor.clear(false)}}},save:function(o){if(this._editor.getHandle().checked){o.write(this._editor.getParam("value"))}else{o.discardNodeIfEmpty()}},update:function(o){},clear:function(){this._editor.getHandle().checked=false}};var a=function(p,o){this._handle=p;this._document=o;this._params=[];this._isModified=false;this._delegate=null};a.prototype={init:function(u,t,p,o,r){var q,s;if(t){if(typeof(t)==="string"){xtiger.util.decodeParameters(t,this._params)}else{if(typeof(t)==="object"){this._params=t}}}q=this.getParam("type");if((q==="text")||(q==="password")){this._delegate=new g(this,q,u)}else{if((q==="radio")||(q==="checkbox")){this._delegate=new e(this,q,r?r.getClockCount():undefined)}else{xtdom.addClassName(this._handle,"axel-generator-error");xtdom.setAttribute(this._handle,readonly,"1");xtdom.setAttribute(this._handle,value,'ERROR: type "'+q+'" not recognized by plugin "input"')}}this._isOptional=p?true:false;if(p){this._optCheckBox=this._handle.previousSibling;if(p==="unset"){this._isOptionSet=true}(p==="set")?this.set(false):this.unset(false)}if(this.getParam("hasClass")){xtdom.addClassName(this._handle,this.getParam("hasClass"))}this.awake()},awake:function(){var o=this;this._delegate.awake();if(this.isOptional()){xtdom.addEventListener(this._optCheckBox,"click",function(p){o.onToggleOpt(p)},true)}},makeSeed:function(){if(!this._seed){this._seed=[m,this._defaultData,this._params,this._isOptional]}return this._seed},remove:function(){},can:function(o){return typeof this[o]==="function"},execute:function(o,p){return this[o](p)},isFocusable:function(){return this._delegate.isFocusable()},focus:function(){if(this._delegate.focus){this._delegate.focus()}},unfocus:function(){if(this._delegate.focus){this._delegate.unfocus()}},load:function(p,o){this._delegate.load(p,o)},save:function(o){if(this.isOptional()&&!this._isOptionSet){o.discardNodeIfEmpty()}else{this._delegate.save(o)}},update:function(o){this._delegate.update(o)},clear:function(o){this._delegate.clear();this._isModified=false;if(this.isOptional()&&this.isSet()){this.unset(o)}},dump:function(){return this._delegate.dump()},getHandle:function(){return this._handle},getDocument:function(){return this._document},getParam:function(o){return this._params[o]},isModified:function(){return this._isModified},setModified:function(o){this._isModified=o},isOptional:function(){return this._isOptional},isSet:function(){return this._isOptional&&(this._isOptionSet?true:false)},set:function(o){if(o){if(!this._params.noedit){xtiger.editor.Repeat.autoSelectRepeatIter(this.getHandle())}xtdom.removeClassName(this._handle,"axel-repeat-unset")}if(this._isOptionSet){return}this._isOptionSet=true;if(this._isOptional){this._handle.disabled=false;this._optCheckBox.checked=true}},unset:function(o){if(!this._isOptionSet){return}this._isOptionSet=false;if(this._isOptional){this._handle.disabled=true;this._optCheckBox.checked=false}},onToggleOpt:function(o){this._isOptionSet?this.unset(true):this.set(true)}};var h="input";var k=0;var m={createModel:function d(s,r,p){var o=xtdom.createElement(p,"input");var t=r.getAttribute("option");if(t){var q=xtdom.createElement(p,"input");xtdom.setAttribute(q,"type","checkbox");xtdom.addClassName(q,"axel-option-checkbox");s.appendChild(q)}s.appendChild(o);return o},createEditorFromTree:function c(q,p,o){var s=new a(q,o);var r={};xtiger.util.decodeParameters(p.getAttribute("param"),r);if(r.filter){xtiger.cross.log("debug","applying filter "+r.filter);s=this.applyFilters(s,r.filter)}s.init(xtdom.extractDefaultContentXT(p),p.getAttribute("param"),p.getAttribute("option"),this.createUniqueKey());return s},createEditorFromSeed:function j(s,v,o,q){var u=new a(v,o);var r=s[1];var p=s[2];var t=s[3];if(p.filter){u=this.applyFilters(u,p.filter)}u.init(r,p,t,this.createUniqueKey(),q);return u},createUniqueKey:function f(){return h+(k++)}};xtiger.editor.Plugin.prototype.pluginEditors.input=xtiger.util.filterable("input",m)}());(function(d){function c(j,k,l){var h=$(k),i;this.axelPath=l;this.key=j;this.templateUrl=h.attr("data-template");this.dataUrl=h.attr("data-src");this.cancelUrl=h.attr("data-cancel");this.transaction=h.attr("data-transaction");this.spec=h;if(this.templateUrl){i=this.templateUrl.substring(this.templateUrl.lastIndexOf("/")+1);if(i.indexOf("?")!=-1){i=i.substring(0,i.indexOf("?"))}$("body").addClass("edition").addClass(i);this.initialize();if(this.cancelUrl){$(window).bind("unload",$.proxy(this,"reportCancel"))}}else{$oppidum.logError('Missing data-template attribute to generate the editor "'+this.key+'"')}$(document).triggerHandler("AXEL-TEMPLATE-READY",[this])}c.prototype={attr:function(h){return this.spec.attr(h)},initialize:function(){var h=new xtiger.util.Logger(),j,k,i,j=xtiger.debug.loadDocument(this.templateUrl,h);if(j){this.form=new xtiger.util.Form(this.axelPath);this.form.setTemplateSource(j);this.form.setTargetDocument(document,this.key,true);this.form.enableTabGroupNavigation();this.form.transform(h);if(this.dataUrl){k=xtiger.cross.loadDocument(this.dataUrl,h);if(k){if($("error > message",k).size()>0){h.$oppidum.logError($("error > message",k).text())}else{i=new xtiger.util.DOMDataSource(k);this.form.loadData(i,h)}}}}if(h.inError()){$oppidum.logError(h.printErrors())}},reset:function(){var h=new xtiger.util.Logger();if(this.form){this.form.transform(h)}if(h.inError()){$oppidum.logError(h.printErrors())}},serializeData:function(j){var h,i;if(this.form){h=new xtiger.util.DOMLogger();this.form.serializeData(h);i=h.dump()}return i},reportCancel:function(h){if(!this.hasBeenSaved){$.ajax({url:this.cancelUrl,data:{transaction:this.transaction},type:"GET",async:false})}}};var a=0,e=0;var b={};var f={};d.$oppidum={logError:function(h){alert(h)},registerCommand:function(i,h){b[i]=h},createEditor:function(i,j){var h=$(i).attr("id")||"untitled"+(a++);f[h]=new c(h,i,j)},createCommand:function(j){var i=$(j).attr("data-command");var h=$(j).attr("data-target")||"untitled"+(e++);if(b[i]){new b[i](h,j)}else{logError('Attempt to create an unkown command "'+i+'"')}},getEditor:function(h){return f[h]}};function g(){var i=$("script[data-bundles-path]").attr("data-bundles-path"),h=$("div[data-template]");if(h.length>0){if(i){h.each(function(k,j){$oppidum.createEditor(j,i)})}else{$oppidum.logError("Cannot start editing because AXEL library path is unspecified")}}$("*[data-command]").each(function(k,j){$oppidum.createCommand(j)})}jQuery(function(){g()})}(window));(function(){function a(c,d){var b=$(d);this.key=c;this.formid=b.attr("data-form");if($oppidum.getEditor(this.key)){if(this.formid&&($("form#"+this.formid).length>0)){d.disabled=false;b.bind("click",$.proxy(this,"execute"))}else{d.disabled=true;$oppidum.logError('Missing or invalid data-form attribute in submit command ("'+this.formid+'")')}}else{d.disabled=true;$oppidum.logError('Missing or invalid data-target attribute in submit command ("'+this.key+'")')}}a.prototype={execute:function(){var c=$("#"+this.formid),e=$("#"+this.formid+' > input[name="data"]'),b=$oppidum.getEditor(this.key);if(b&&(c.length>0)&&(e.length>0)){e.val(b.serializeData());c.submit()}else{$oppidum.logError("Missing editor or malformed form element to submit data")}}};$oppidum.registerCommand("submit",a)}());(function(){function a(c,d){var b=$(d);this.label={preview:b.attr("data-preview-label")||b.text(),edit:b.attr("data-edit-label")||"Edit"};b.bind("click",$.proxy(this,"execute"))}a.prototype={execute:function(c){var b=$("body"),d=!b.hasClass("preview");$(c.target).text(this.label[d?"edit":"preview"]);b.toggleClass("preview",d)}};$oppidum.registerCommand("preview",a)}());(function(){function a(b,c){this.key=b;if($oppidum.getEditor(this.key)){$(c).bind("click",$.proxy(this,"execute"));c.disabled=false}else{c.disabled=true;$oppidum.logError('Missing or invalid data-target attribute in reset command ("'+this.key+'")')}}a.prototype={execute:function(c){var b=$oppidum.getEditor(this.key);if(b){b.reset()}}};$oppidum.registerCommand("reset",a)}());(function(){function a(b,c){this.spec=$(c);this.key=b;if($oppidum.getEditor(this.key)){c.disabled=false;this.spec.bind("click",$.proxy(this,"execute"))}else{c.disabled=true;$oppidum.logError('Missing editor in save command ("'+this.key+'")')}}a.prototype=(function(){function f(g){return $("error > message",g.responseXML).size()>0}function e(h){var g=$("error > message",h.responseXML).text();return g||h.status}function b(l){var k=l.responseText,h=l.status;var j="Error ! Result code : "+h;var i="";var g=k.match("<title>(.*)</title>","m");if(g){i="\n"+g[1]}g=k.match("<h2>(.*)</h2>","m");if(g){i=i+"\n"+g[1]}else{if($("div.message",l.responseXML).size()>0){i=i+"\n"+$("div.message",l.responseXML).get(0).textContent;if($("div.description",l.responseXML).size()>0){i=i+"\n"+$("div.description",l.responseXML).get(0).textContent}}}return j+i}function d(h,g,j){var i=j.getResponseHeader("Location");if(j.status=201){if(i){window.location.href=i}else{$oppidum.logError(e(j))}}else{$oppidum.logError("Unexpected response from server ("+j.status+"). Save action may have failed")}}function c(j,g,i){var h;if(g==="timeout"){$oppidum.logError("Save action taking too much time, it has been aborted, however it is possible that your page has been saved")}else{if(j.status===409){h=j.getResponseHeader("Location");if(h){window.location.href=h}else{$oppidum.logError(e(j))}}else{if(f(j)){$oppidum.logError(e(j))}else{if(j.responseText.search("Error</title>")!=-1){$oppidum.logError(b(j))}else{if(i){$oppidum.logError("Exception : "+i.name+" / "+i.message+"\n (line "+i.lineNumber+")")}else{$oppidum.logError('Error while connecting to "'+this.url+'" ('+j.status+")")}}}}}}return{execute:function(h){var g=$oppidum.getEditor(this.key),l,j,k,i;if(g){url=g.attr("data-src")||this.spec.attr("data-src")||".";if(url){i=g.serializeData();if(i){l=g.attr("data-method")||this.spec.attr("data-method")||"post";k=g.attr("data-transaction")||this.spec.attr("data-transaction");if(k){url=url+"?transaction="+k}$.ajax({url:url,type:l,data:i,dataType:"xml",cache:false,timeout:10000,contentType:"application/xml; charset=UTF-8",success:d,error:c});g.hasBeenSaved=true}else{$oppidum.logError("The editor did not generate any data")}}else{$oppidum.logError("The command does not know where to send the data")}}else{$oppidum.logError("There is no editor associated with this command")}}}}());$oppidum.registerCommand("save",a)}());